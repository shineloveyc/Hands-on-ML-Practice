---
title: "Final Report"
author: "Shine Yao,Alex Nguyen,Sharon Bao,Charlie Chen"
date: "4/9/2018"
output:
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown
*The URL for our Team GitHub repository is:https://github.com/shineloveyc/Marketing-Analytics-Project

*Color Scheme Reference:http://colorbrewer2.org/#type=sequential&scheme=PuBuGn&n=3

*Small parts of the code refer to :https://www.kaggle.com/jboysen/ny-home-mortgage/kernels

## Load the package
```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(ggplot2)
library(rpart)
library(rpart.plot)
library(caTools)
library(caret)
library(DT)
library(knitr)
library(dplyr)
library(rcompanion)
library(poLCA)
library(seg)
```

##1. What is the data problem? What is the final managerial objective?
The data set organized under The Home Mortgage Disclosure Act (HMDA) covers all mortgage decision made in 2015 for the state of New York. Under this Act, financial institutions with offices in mmetropolitan areas are required to disclose reports and documents about mortgages data; for example the disposition of each application for mortgage credit, the characteristics of mortgages initiated during the year, or personal demographic information about loans applicants. In this data set, these mortgages information are revealed to help answer questions of: whether lenders are serving housing needs of their communities, whether public officials can rely on these data to make decisions or issue policies, and whether there are certain lending patterns. The data set is pulled by the Consumer Finance Protection Board. Thus, their goal would be to figure out where in New York mortgages are most likely to get approved. Another managerial objective is also to analyze which factors (such as gender, ethnicity, income) play a major role in mortgage decisions. From here, they can make necessary prediction about what probability of getting a loan approved based on the criteria ,and also reduce the workload by focusing on examing those key preidctors instead of all variables.

##2. Describe the measurement types of each variable
*Interval Variable: as_of_year
*Ratio Variables: applicant_income_000s,hud_median_family_income, loan_amount_000s, number_of_1_to_4_family_units, number_of_owner_occupied_units, minority_population, population, rate_spread, tract_to_msamd_income
*Nominal Variables: all other variables (eg: action_taken, agency_name, country_name ...)

##3. How do you handle missing data in this dataset?
After we know what the variables represent, we need to check if there exist missing data in the dataset and handle the problem in order to do further analysis.
```{r, echo = FALSE, message=FALSE, warning=FALSE}
setwd("~/Downloads/Marketing-Analytics-Project-master/Marketing-Analytics-Project")
homeMortgage <- read.csv("ny_hmda_2015.csv")
sapply(homeMortgage, function(x) sum(is.na(x)))
```
After checking, we find out that missing data exist for these nominal variables: "applicant_race_2", "applicant_race_3", "applicant_race_4", "applicant_race_5", "census_tract_number", "co_applicant_race_2", "co_applicant_race_3", "co_applicant_race_4", "co_applicant_race_5", "county_code", "denial_reason_1", "denial_reason_2", "denial_reason_3", "edit status", "msamd".
Moreover, missing data exist for these ratio variables: "applicant_income_000s", "hud_median_family_income", "number_of_1_to_4_family_units", "number_of_owner_occupied_units", "minority_population", "population", "rate_spread", "tract_to_msamd_income".

In order to drop the missing data in the dataset, we first categorize the missing data into three categories: MCAR, MAR, and MNAR. We find out that all missing data for nominal variables are NMAR, as they are all missing due to applicant left blank for description variables, or the option is not appliable to them. Therefore, we will fill these data with "NA" or word explainations to indicate that these data are not being collected or not apppliable to the applicants.
```{r, message=FALSE, warning=FALSE}
#check for correlation of the nominal variables with loan originated
homeMortgage$isMissing.applicant_race_2 = 0
homeMortgage$isMissing.applicant_race_2 [is.na(homeMortgage$applicant_race_2)] = 1
tb.applicant_race_2 <- table(homeMortgage$action_taken, homeMortgage$isMissing.applicant_race_2)
chisq.test(tb.applicant_race_2)
#not highly correlated, delete column

homeMortgage$isMissing.applicant_race_3 = 0
homeMortgage$isMissing.applicant_race_3 [is.na(homeMortgage$applicant_race_3)] = 1
tb.applicant_race_3 <- table(homeMortgage$action_taken, homeMortgage$isMissing.applicant_race_3)
chisq.test(tb.applicant_race_3)
#not highly correlated, delete column

homeMortgage$isMissing.applicant_race_4 = 0
homeMortgage$isMissing.applicant_race_4 [is.na(homeMortgage$applicant_race_4)] = 1
tb.applicant_race_4 <- table(homeMortgage$action_taken, homeMortgage$isMissing.applicant_race_4)
chisq.test(tb.applicant_race_4)
#not highly correlated, delete column

homeMortgage$isMissing.applicant_race_5 = 0
homeMortgage$isMissing.applicant_race_5 [is.na(homeMortgage$applicant_race_5)] = 1
tb.applicant_race_5 <- table(homeMortgage$action_taken, homeMortgage$isMissing.applicant_race_5)
chisq.test(tb.applicant_race_5)
#not highly correlated, delete column

homeMortgage$isMissing.census_tract_number = 0
homeMortgage$isMissing.census_tract_number [is.na(homeMortgage$census_tract_number)] = 1
tb.census_tract_number <- table(homeMortgage$action_taken, homeMortgage$isMissing.census_tract_number)
chisq.test(tb.census_tract_number)
#not highly correlated, delete column

homeMortgage$isMissing.county_code = 0
homeMortgage$isMissing.county_code [is.na(homeMortgage$county_code)] = 1
tb.county_code <- table(homeMortgage$action_taken, homeMortgage$isMissing.county_code)
chisq.test(tb.county_code)
#not highly correlated, delete column

homeMortgage$isMissing.denial_reason_1 = 0
homeMortgage$isMissing.denial_reason_1 [is.na(homeMortgage$denial_reason_1)] = 1
tb.denial_reason_1 <- table(homeMortgage$action_taken, homeMortgage$isMissing.denial_reason_1)
chisq.test(tb.denial_reason_1)
#not highly correlated, delete column

homeMortgage$isMissing.denial_reason_2 = 0
homeMortgage$isMissing.denial_reason_2 [is.na(homeMortgage$denial_reason_2)] = 1
tb.denial_reason_2 <- table(homeMortgage$action_taken, homeMortgage$isMissing.denial_reason_2)
chisq.test(tb.denial_reason_2)
#not highly correlated, delete column

homeMortgage$isMissing.denial_reason_3 = 0
homeMortgage$isMissing.denial_reason_3 [is.na(homeMortgage$denial_reason_3)] = 1
tb.denial_reason_3 <- table(homeMortgage$action_taken, homeMortgage$isMissing.denial_reason_3)
chisq.test(tb.denial_reason_3)
#not highly correlated, delete column

#delete all nominal variable columns with missing data

homeMortgage <- homeMortgage%>%
     dplyr::select(-applicant_race_2,-applicant_race_3, -applicant_race_4, -applicant_race_5, -co_applicant_race_2, -co_applicant_race_3, -co_applicant_race_4, -co_applicant_race_5, -county_code, -denial_reason_1, -denial_reason_2, -denial_reason_3, -denial_reason_name_1, -denial_reason_name_2, -denial_reason_name_3, -edit_status, -edit_status_name, -census_tract_number, -applicant_race_name_2, -applicant_race_name_3, -applicant_race_name_4, -applicant_race_name_5, -co_applicant_race_name_2, -co_applicant_race_name_3, -co_applicant_race_name_4, -co_applicant_race_name_5)
```
All missing data for ratio variables are MAR, therefore we will use the mean to replace the missing data in the 8 ratio variable columns.
```{r}
#create dummy variables to check if data is missing at random
homeMortgage$isMissing.applicant_income_000s = 0
homeMortgage$isMissing.applicant_income_000s [is.na(homeMortgage$applicant_income_000s)] = 1
tb.applicant_income_000s <- table(homeMortgage$action_taken, homeMortgage$isMissing.applicant_income_000s)
chisq.test(tb.applicant_income_000s)
#need to change missing data to mean for applicant_income_000s

homeMortgage$isMissing.hud_median_family_income = 0
homeMortgage$isMissing.hud_median_family_income [is.na(homeMortgage$hud_median_family_income)] = 1
tb.hud_median_family_income <- table(homeMortgage$action_taken, homeMortgage$isMissing.hud_median_family_income)
chisq.test(tb.hud_median_family_income)
#need to change missing data to mean

homeMortgage$isMissing.number_of_1_to_4_family_units = 0
homeMortgage$isMissing.number_of_1_to_4_family_units [is.na(homeMortgage$number_of_1_to_4_family_units)] = 1
tb.number_of_1_to_4_family_units <- table(homeMortgage$action_taken, homeMortgage$isMissing.number_of_1_to_4_family_units)
chisq.test(tb.number_of_1_to_4_family_units)
#need to change missing data to mean

homeMortgage$isMissing.number_of_owner_occupied_units = 0
homeMortgage$isMissing.number_of_owner_occupied_units [is.na(homeMortgage$number_of_owner_occupied_units)] = 1
tb.number_of_owner_occupied_units <- table(homeMortgage$action_taken, homeMortgage$isMissing.number_of_owner_occupied_units)
chisq.test(tb.number_of_owner_occupied_units)
#need to change missing data to mean

homeMortgage$isMissing.minority_population = 0
homeMortgage$isMissing.minority_population [is.na(homeMortgage$minority_population)] = 1
tb.minority_population <- table(homeMortgage$action_taken, homeMortgage$minority_population)
chisq.test(tb.minority_population)
#need to change missing data to mean

homeMortgage$isMissing.population = 0
homeMortgage$isMissing.population [is.na(homeMortgage$population)] = 1
tb.population <- table(homeMortgage$action_taken, homeMortgage$isMissing.population)
chisq.test(tb.population)
#need to change missing data to mean

homeMortgage$isMissing.rate_spread = 0
homeMortgage$isMissing.rate_spread [is.na(homeMortgage$rate_spread)] = 1
tb.rate_spread <- table(homeMortgage$action_taken, homeMortgage$isMissing.rate_spread)
chisq.test(tb.rate_spread)
#need to change missing data to mean

homeMortgage$isMissing.tract_to_msamd_income = 0
homeMortgage$isMissing.tract_to_msamd_income [is.na(homeMortgage$tract_to_msamd_income)] = 1
tb.tract_to_msamd_income <- table(homeMortgage$action_taken, homeMortgage$isMissing.tract_to_msamd_income)
chisq.test(tb.tract_to_msamd_income)
#need to change missing data to mean

#replace missing data with the mean of each variable
homeMortgage$applicant_income_000s[is.na(homeMortgage$applicant_income_000s)] <- round( mean(homeMortgage$applicant_income_000s, na.rm = TRUE))
homeMortgage[is.na(homeMortgage$hud_median_family_income), ]$hud_median_family_income <- round( mean(homeMortgage$hud_median_family_income, na.rm = TRUE))
homeMortgage[is.na(homeMortgage$number_of_1_to_4_family_units), ]$number_of_1_to_4_family_units <- round( mean(homeMortgage$number_of_1_to_4_family_units, na.rm = TRUE))
homeMortgage[is.na(homeMortgage$number_of_owner_occupied_units), ]$number_of_owner_occupied_units <- round( mean(homeMortgage$number_of_owner_occupied_units, na.rm = TRUE))
homeMortgage[is.na(homeMortgage$minority_population), ]$minority_population <- round( mean(homeMortgage$minority_population, na.rm = TRUE))
homeMortgage[is.na(homeMortgage$population), ]$population <- round( mean(homeMortgage$population, na.rm = TRUE))
homeMortgage[is.na(homeMortgage$rate_spread), ]$rate_spread <- round( mean(homeMortgage$rate_spread, na.rm = TRUE))
homeMortgage[is.na(homeMortgage$tract_to_msamd_income), ]$tract_to_msamd_income <- round( mean(homeMortgage$tract_to_msamd_income, na.rm = TRUE))
#recheck if all missing data have been handled
sapply(homeMortgage, function(x) sum(is.na(x)))
```

##4. Create a table summarizing the range or variation in each variable. Add statistics (mean,median, standard deviation, etc.) as you deem necessary.
In this dataset, we have 11 continous variables and 67 discrete variables. For the 67 discrete variables, many of them are indicators for other variables. For example, "applicant_race_1" is the indicator variable for "applicant_race_name_1". Therefore, we will only present frequency tables for selected discrete variables that we deem important for analysis. Hence, the frequency tables for "action_taken_name", "agency_name", "applicant_ethnicity_name", "applicant_sex_name", "county_name","hoepa_status_name","lien_status_name", "loan_purpose_name","loan_type_name", "property_type_name", "purchaser_type_name", and "state_name" are presented below. Please check the Appendix for table of modes for all discrete variables.

```{r, message=FALSE, warning=FALSE}

###for reference, not add in offical report
# frequency distribution tables for selected discrete variables
# "purchaser_type_name", and "state_name"

#Histogram for action_taken_name
fillColor = "#1c9099"
homeMortgageStatus <- homeMortgage %>%
  group_by(action_taken_name) %>%
  summarize(count = n()) %>%
  arrange(desc(count))

homeMortgageStatus %>% ggplot(aes(x = reorder(action_taken_name,count), y = count)) + 
  geom_bar(stat = 'identity',colour = "white", fill = fillColor) +
  labs(x = 'Action Taken Name', y = 'Count Of Action Taken', title = 'Actions in Loans') +
  coord_flip() + 
  theme_bw() 

#Histogram for agency_name
fillColor = "#1c9099"
agency_name <- homeMortgage %>%
  group_by(agency_name) %>% 
  summarize(count = n()) %>%
  arrange(desc(count)) 

agency_name %>% ggplot(aes(x = reorder(agency_name, count), y = count)) + 
  geom_bar(stat = 'identity',colour="white", fill =fillColor) +
  labs(x = 'Agency Name', y = 'Count', title = 'Agency Name Distribution') +
  coord_flip() + 
  theme_bw()

 #Histogram for county_name
 fillColor = "#1c9099"
 county_name <- homeMortgage %>%
     group_by(county_name) %>% 
     summarize(count = n()) %>%
     arrange(desc(count)) 
 
 county_name %>% ggplot(aes(x = reorder(county_name, count), y = count)) + 
     geom_bar(stat = 'identity',colour="white", fill =fillColor) +
     labs(x = 'County Name', y = 'Count', title = 'County Name Distribution') +
     coord_flip() + 
     theme_bw()

#Histogram for applicant_sex_name
fillColor = "#1c9099"

applicant_sex_name <- homeMortgage %>%
  group_by(applicant_sex_name) %>% 
  summarize(count = n()) %>%
  arrange(desc(count)) 

levels(applicant_sex_name$applicant_sex_name)[levels(applicant_sex_name$applicant_sex_name) == "Information not provided by applicant in mail, Internet, or telephone application"] <- "Information not provided"

applicant_sex_name %>% ggplot(aes(x = reorder(applicant_sex_name, count), y = count)) + 
  geom_bar(stat = 'identity',colour="white", fill =fillColor) +
  labs(x = 'Applicant Sex', y = 'Count', title = 'Applicant Sex Distribution') +
  coord_flip() + 
  theme_bw()

#Histogram for applicant_ethnicity_name
ethnicity_name <- homeMortgage %>%
  group_by(applicant_ethnicity_name) %>% 
  summarize(count = n()) %>%
  arrange(desc(count)) 

levels(ethnicity_name$applicant_ethnicity_name)[levels(ethnicity_name$applicant_ethnicity_name) == "Information not provided by applicant in mail, Internet, or telephone application"] <- "Information not provided"

ethnicity_name %>% ggplot(aes(x = reorder(applicant_ethnicity_name, count), y = count)) + 
  geom_bar(stat = 'identity', colour="white", fill =fillColor) +
  labs(x = 'Ethnicity Name', y = 'Count', title = 'Ethnicity Name Distribution') +
  coord_flip() + 
  theme_bw()

#Histogram for hoepa_status_name
fillColor = "#1c9099"

hoepa_status_name <- homeMortgage %>%
  group_by(hoepa_status_name) %>% 
  summarize(count = n()) %>%
  arrange(desc(count)) 

hoepa_status_name %>% ggplot(aes(x = reorder(hoepa_status_name, count), y = count)) + 
  geom_bar(stat = 'identity',colour="white", fill =fillColor) +
  labs(x = 'Hoepa Status Name', y = 'Count', title = 'Hoepa Status Name Distribution') +
  coord_flip() + 
  theme_bw() 

#Histogram for lien_status_name
fillColor = "#1c9099"

lien_name <- homeMortgage %>%
  group_by(lien_status_name) %>% 
  summarize(count = n()) %>%
  arrange(desc(count)) 

lien_name %>% ggplot(aes(x = reorder(lien_status_name, count), y = count)) + 
  geom_bar(stat = 'identity',colour="white", fill =fillColor) +
  labs(x = 'Lien Status Name', y = 'Count', title = 'Lien Status Name Distribution') +
  coord_flip() + 
  theme_bw()

#Histogram for loan_purpose_name
fillColor = "#1c9099"

loan_purpose_name <- homeMortgage %>%
  group_by(loan_purpose_name) %>% 
  summarize(count = n()) %>%
  arrange(desc(count)) 

loan_purpose_name %>% ggplot(aes(x = reorder(loan_purpose_name, count), y = count)) + 
  geom_bar(stat = 'identity',colour="white", fill =fillColor) +
  labs(x = 'Loan Purpose Name', y = 'Count', title = 'Loan Purpose Name Distribution') +
  coord_flip() + 
  theme_bw()

#Histogram for loan_type_name
fillColor = "#1c9099"

loan_type_name <- homeMortgage %>%
  group_by(loan_type_name) %>% 
  summarize(count = n()) %>%
  arrange(desc(count)) 

loan_type_name %>% ggplot(aes(x = reorder(loan_type_name, count), y = count)) + 
  geom_bar(stat = 'identity',colour="white", fill =fillColor) +
  labs(x = 'Loan Type Name', y = 'Count', title = 'Loan Type Name Distribution') +
  coord_flip() + 
  theme_bw() 

#Histogram for property_type_name
fillColor = "#1c9099"
property_type_name <- homeMortgage %>%
    group_by(property_type_name) %>% 
    summarize(count = n()) %>%
    arrange(desc(count)) 
levels(property_type_name$property_type_name)[levels(property_type_name$property_type_name) == "One-to-four family dwelling (other than manufactured housing)"] <- "1 to 4 family dwelling"

property_type_name %>% ggplot(aes(x = reorder(property_type_name, count), y = count)) + 
    geom_bar(stat = 'identity',colour="white", fill =fillColor) +
    labs(x = 'Property Type Name', y = 'Count', title = 'Property Type Name Distribution') +
    coord_flip() + 
    theme_bw()

#Histogram for purchaser_type_name
fillColor = "#1c9099"
purchaser_type_name <- homeMortgage %>%
    group_by(purchaser_type_name) %>% 
    summarize(count = n()) %>%
    arrange(desc(count)) 

purchaser_type_name %>% ggplot(aes(x = reorder(purchaser_type_name, count), y = count)) + 
    geom_bar(stat = 'identity',colour="white", fill =fillColor) +
    labs(x = 'Purchaser Type Name', y = 'Count', title = 'Purchaser Type Name Distribution') +
    coord_flip() + 
    theme_bw()
```

```{r, message=FALSE, warning=FALSE}
#Create a data summary table for continuous variables
# From Part 2, we know that only "applicant_income_000s", "as_of_year", "hud_median_family_income", "loan_amount_000s", "number_of_1_to_4_family_units", "number_of_owner_occupied_units", "minority_population", "population", "rate_spread", "tract_to_msamd_income" are continous variables. Therefore, there are only 11 continuous variables exist in the dataset. We will provide statistics including median, mode, mean, range, and standard deviation.

homeMortgageContinuous.df <- data.frame(matrix(NA, nrow = 10, ncol = 5))
names(homeMortgageContinuous.df) <- c("Mean", "Median", "Mode","Range", "Standard Deviation")
rownames(homeMortgageContinuous.df) <- c("applicant_income_000s", "as_of_year", "hud_median_family_income", "loan_amount_000s", "number_of_1_to_4_family_units", "number_of_owner_occupied_units", "minority_population", "population", "rate_spread", "tract_to_msamd_income")

#Define the Mode function
Mode = function(x){
ux = sort(unique(x))
tabx = table(x)
maxf = ux[which(tabx == max(tabx))]
return(maxf)}

#disable scientific notion 
options(scipen = 999)

# Create seperate dataset "homeMortgageContinuous"
homeMortgageContinuous <- homeMortgage %>%
  dplyr::select(applicant_income_000s, as_of_year, hud_median_family_income, loan_amount_000s, number_of_1_to_4_family_units, number_of_owner_occupied_units, minority_population, population, rate_spread, tract_to_msamd_income)

#Use for loop to calculate statistics of the continuous variables
#calculate mean of the continous variable
for (Num in c(1:nrow(homeMortgageContinuous.df))){
    homeMortgageContinuous.df[Num, 1] = round(mean(homeMortgageContinuous[[Num]], na.rm = TRUE))
}

#calculate median of the continous variable
for (Num in c(1:nrow(homeMortgageContinuous.df))){
     homeMortgageContinuous.df[Num, 2] = round(median(homeMortgageContinuous[[Num]], na.rm = TRUE))
}

#calculate mode of the continous variables
for (Num in c(1:nrow(homeMortgageContinuous.df))){
     homeMortgageContinuous.df[Num, 3] = Mode(homeMortgageContinuous[[Num]]) 
}

#calculate range of the continous variables
for (Num in c(1:nrow(homeMortgageContinuous.df))){
     homeMortgageContinuous.df[Num, 4] = round(max(homeMortgageContinuous[[Num]], na.rm = TRUE) - min(homeMortgageContinuous[[Num]], na.rm = TRUE))
}

# calculate the standard deviation of continous variables
for (Num in c(1:nrow(homeMortgageContinuous.df))){
     homeMortgageContinuous.df[Num, 5] = round(sd(homeMortgageContinuous[[Num]], na.rm = TRUE)) 
}

#Round and print result
kable(homeMortgageContinuous.df, caption = "Continuous Variable Statistics Table")

```


##5. Create bivariate frequency distributions (tables or plots) for key variables
```{r, message=FALSE, warning=FALSE, fig.width = 8, fig.height = 6}
# Define Loan Approval
homeMortgage = homeMortgage %>%
  mutate(Loan_Approval = ifelse(action_taken_name == "Loan originated", "1", ifelse(action_taken_name == "Loan purchased by the institution", "1", ifelse(action_taken_name == "Application approved but not accepted", "1", "0"))))

homeMortgage$Loan_Approval.level = "loan approved"
homeMortgage[homeMortgage$Loan_Approval == "0",]$Loan_Approval.level = "loan not approved"
# We refer to Moody's economic analysis report to give out the loan approval of our own. Loan purchaded by the institution is defined as loan pre-approved by bank then sell to other financial institution. The major difference is whether the institution offers deposit account.
# Sex and Loan originated
fillColor = "#1c9099"

applicant_sex_name <- homeMortgage %>%
  group_by(applicant_sex_name) %>% 
  summarize(CountOfSex = n()) %>%
  arrange(desc(CountOfSex))

levels(applicant_sex_name$applicant_sex_name)[levels(applicant_sex_name$applicant_sex_name) == "Information not provided by applicant in mail, Internet, or telephone application"] <- "Information not provided"

homeMortgage_applicant_sex = homeMortgage %>%group_by(Loan_Approval.level,applicant_sex_name) %>%
  summarise(CountOfActionTaken = n()) %>%
  arrange(desc(CountOfActionTaken))

levels(homeMortgage_applicant_sex$applicant_sex_name)[levels(homeMortgage_applicant_sex$applicant_sex_name) == "Information not provided by applicant in mail, Internet, or telephone application"] <- "Information not provided"

homeMortgageStatus_sex = inner_join(applicant_sex_name,homeMortgage_applicant_sex)%>%mutate(percentage = (CountOfActionTaken/CountOfSex) * 100 )  

homeMortgageStatus_sex%>%
ggplot(aes(x = reorder(applicant_sex_name, CountOfSex), 
                                          y = percentage)) +
  geom_bar(stat='identity',colour="white", fill =fillColor) +
  facet_wrap(~ Loan_Approval.level) +
  labs(x = 'Sex', y = 'Percentage of Status', title = 'Loan Approval Status by Sex') +
  coord_flip() + 
  theme_bw()

# race and Loan Originated
fillColor = "#1c9099"
race_name <- homeMortgage %>%
  group_by(applicant_race_name_1) %>% 
  summarize(CountOfRace = n()) %>%
  arrange(desc(CountOfRace)) 

levels(race_name$applicant_race_name_1)[levels(race_name$applicant_race_name_1) == "Information not provided by applicant in mail, Internet, or telephone application"] <- "Information not provided"

homeMortgage_applicant_race= homeMortgage %>%group_by(Loan_Approval.level,applicant_race_name_1) %>% 
  summarise(CountOfActionTaken = n()) %>%
  arrange(desc(CountOfActionTaken))

levels(homeMortgage_applicant_race$applicant_race_name_1)[levels(homeMortgage_applicant_race$applicant_race_name_1) == "Information not provided by applicant in mail, Internet, or telephone application"] <- "Information not provided"

homeMortgageStatus_race = inner_join(race_name,homeMortgage_applicant_race) 


homeMortgageStatus_race%>%
ggplot(aes(x = reorder(applicant_race_name_1, CountOfRace), 
                                          y = CountOfActionTaken)) +
  geom_bar(stat='identity',colour="white", fill =fillColor) +
  facet_wrap(~ Loan_Approval.level) +
  labs(x = 'Race', y = 'Count Of Status', title = 'Loan Approval Status by Race') +
  coord_flip() + 
  theme_bw()

# Ethnicity and Loan Originated
ethnicity_name <- homeMortgage %>%
  group_by(applicant_ethnicity_name) %>% 
  summarize(CountOfEthinity = n()) %>%
  arrange(desc(CountOfEthinity)) 

levels(ethnicity_name$applicant_ethnicity_name)[levels(ethnicity_name$applicant_ethnicity_name) == "Information not provided by applicant in mail, Internet, or telephone application"] <- "Information not provided"

homeMortgage_applicant_ethnicity= homeMortgage %>%group_by(Loan_Approval.level,applicant_ethnicity_name) %>%
  summarise(CountOfActionTaken = n()) %>%
  arrange(desc(CountOfActionTaken))

levels(homeMortgage_applicant_ethnicity$applicant_ethnicity_name)[levels(homeMortgage_applicant_ethnicity$applicant_ethnicity_name) == "Information not provided by applicant in mail, Internet, or telephone application"] <- "Information not provided"

homeMortgageStatus_ethnicity = inner_join(ethnicity_name,homeMortgage_applicant_ethnicity) %>%mutate(percentage = (CountOfActionTaken/CountOfEthinity) * 100 )  

homeMortgageStatus_ethnicity %>% ggplot(aes(x = reorder(applicant_ethnicity_name, CountOfEthinity), y = percentage)) + 
  geom_bar(stat = 'identity', colour="white", fill =fillColor) +
  facet_wrap(~ Loan_Approval.level) +
  labs(x = 'Ethnicity Name', y = 'Percentage of Status', title = 'Loan Approval Status by Ethnicity') +
  coord_flip() + 
  theme_bw()

# county and Loan Originated
fillColor = "#ece2f0"
county_Top10 <- homeMortgage %>%
  group_by(county_name) %>% 
  summarize(CountOfCounty = n()) %>%
  arrange(desc(CountOfCounty)) %>%
  head(10) 

homeMortgage_applicant_county= homeMortgage %>% group_by(Loan_Approval.level,county_name) %>%
  summarise(CountOfActionTaken = n()) %>%
  arrange(desc(CountOfActionTaken))

homeMortgageStatus_county = inner_join(county_Top10,homeMortgage_applicant_county)%>%mutate(percentage = (CountOfActionTaken/CountOfCounty) * 100 )   

 homeMortgageStatus_county %>% ggplot(aes(x= reorder(county_name, CountOfCounty),y=percentage)) + 
  geom_col(colour="white", fill =fillColor) +
    facet_wrap(~ Loan_Approval.level) +
  labs(x = 'County Name', y = 'Percentage of Status', title = 'Loan Approval Status by Ethnicity') +
    
  coord_flip() + 
  theme_bw()

# Income and Loan Originated Distribution
breaks = seq(0,400,50)
fillColor = "#ece7f2"

homeMortgage %>%
group_by(Loan_Approval.level) %>%
ggplot(aes(applicant_income_000s)) +
  scale_x_continuous(limits = c(0, 400),breaks=breaks ) +
  facet_wrap(~Loan_Approval.level)+
  geom_histogram(binwidth = 10,fill = fillColor) +
  labs(x = 'Income in Thousands', y = 'Count of Status', title = 'Loan Approval Status By Income') +  theme_bw()

# Loan amount and Loan Originated Distribution  
breaks = seq(0,2000,100)
fillColor = "#a6bddb"

homeMortgage %>% 
  group_by(Loan_Approval.level) %>%
  ggplot(aes(loan_amount_000s)) + 
  scale_x_continuous(limits = c(0, 2000),breaks=breaks ) +
  facet_wrap(~Loan_Approval.level)+
  geom_histogram(binwidth = 10,fill = fillColor) +
  labs(x = 'Loan Amount in Thousands', y = 'Count of Status', title = 'Loan Approval Status By loan amount') +  theme_bw()

#hoepa status and Loan Originated Distribution
fillColor = "#a6bddb"

hoepa_status_name <- homeMortgage %>%
  group_by(hoepa_status_name) %>% 
  summarize(CountOfHoepa = n()) %>%
  arrange(desc(CountOfHoepa)) 

homeMortgage_applicant_hoepa= homeMortgage %>% group_by(Loan_Approval.level,hoepa_status_name) %>%
  summarise(CountOfActionTaken = n()) %>%
  arrange(desc(CountOfActionTaken))

homeMortgageStatus_hoepa = inner_join(hoepa_status_name,homeMortgage_applicant_hoepa) 

homeMortgageStatus_hoepa %>% ggplot(aes(x= reorder(hoepa_status_name, CountOfHoepa),y=CountOfActionTaken)) + 
  geom_col(colour="white", fill =fillColor) +
    facet_wrap(~ Loan_Approval.level) +
  labs(x = 'Hoepa Status Name', y = 'Count of Status', title = 'Loan Approval Status by Hoepa Status') +
    
  coord_flip() + 
  theme_bw()
 
#lien status and Loan Action
fillColor = "#756bb1"

lien_name <- homeMortgage %>%
  group_by(lien_status_name) %>% 
  summarize(CountOfLien = n()) %>%
  arrange(desc(CountOfLien)) 

homeMortgage_applicant_lien= homeMortgage %>% 
  group_by(Loan_Approval.level,lien_status_name) %>%
  summarise(CountOfActionTaken = n()) %>%
  arrange(desc(CountOfActionTaken))

homeMortgageStatus_lien = inner_join(lien_name,homeMortgage_applicant_lien)

 homeMortgageStatus_lien %>% ggplot(aes(x = reorder(lien_status_name, CountOfLien), y = CountOfActionTaken)) + 
  geom_bar(stat = 'identity',colour="white", fill =fillColor) +
  facet_wrap(~ Loan_Approval.level) +
  labs(x = 'Lien Status Name', y = 'Count of Status', title = 'Loan Approval Status by Lien Status') +
  coord_flip() + 
  theme_bw()

# loan purpose and mortgage action
fillColor = "#bcbddc"

loan_purpose_name <- homeMortgage %>%
  group_by(loan_purpose_name) %>% 
  summarize(count = n()) %>%
  arrange(desc(count)) 

homeMortgage_applicant_purpose= homeMortgage %>% group_by(Loan_Approval.level,loan_purpose_name) %>%
  summarise(CountOfActionTaken = n()) %>%
  arrange(desc(CountOfActionTaken))

homeMortgageStatus_purpose = inner_join(loan_purpose_name,homeMortgage_applicant_purpose)%>%mutate(percentage = (CountOfActionTaken/count) * 100 )

homeMortgageStatus_purpose %>% ggplot(aes(x = reorder(loan_purpose_name, count), y = percentage)) + 
  geom_bar(stat = 'identity',colour="white", fill =fillColor) +
  facet_wrap(~ Loan_Approval.level) +
  labs(x = 'Loan Purpose Name', y = 'Percentage of Status', title = 'Loan Approval Status by Loan Purpose') +
  coord_flip() + 
  theme_bw()

#loan type and mortgage action
fillColor = "#efedf5"

loan_type_name <- homeMortgage %>%
  group_by(loan_type_name) %>% 
  summarize(count = n()) %>%
  arrange(desc(count)) 

homeMortgage_applicant_type= homeMortgage %>%group_by(Loan_Approval.level,loan_type_name) %>%
  summarise(CountOfActionTaken = n()) %>%
  arrange(desc(CountOfActionTaken))

homeMortgageStatus_type = inner_join(loan_type_name,homeMortgage_applicant_type)%>%mutate(percentage = (CountOfActionTaken/count) * 100 )

homeMortgageStatus_type%>% ggplot(aes(x = reorder(loan_type_name, count), y = percentage)) + 
  geom_bar(stat = 'identity',colour="white", fill =fillColor) +
   facet_wrap(~ Loan_Approval.level) +
  labs(x = 'Loan Type Name', y = 'Percentage of Status', title = 'Loan Approval Status by Loan Type') +
  coord_flip() + 
  theme_bw() 

# msamd_name and loan action
fillColor = "#efedf5"

msamd_name <- homeMortgage %>%
  group_by(msamd_name) %>% 
  summarize(count = n()) %>%
  arrange(desc(count)) 

homeMortgage_applicant_msamd= homeMortgage %>% group_by(msamd_name,Loan_Approval.level) %>%
  summarise(CountOfActionTaken = n()) %>%
  arrange(desc(CountOfActionTaken))

homeMortgageStatus_msamd = inner_join(msamd_name,homeMortgage_applicant_msamd) 

homeMortgageStatus_msamd %>% ggplot(aes(x= reorder(msamd_name, count),y=CountOfActionTaken)) + 
 geom_bar(stat = 'identity',colour="white", fill =fillColor) +
  facet_wrap(~Loan_Approval.level)+
  labs(x = 'MSA/MD Name', y = 'Count of Status', title = 'Loan Approval Status by MSA/MD Name') +
  coord_flip() + 
  theme_bw() 

#property_type and loan action
fillColor = "#a6bddb"

property_type_name <- homeMortgage %>%
  group_by(property_type_name) %>% 
  summarize(count = n()) %>%
  arrange(desc(count)) 

levels(property_type_name$property_type_name)[levels(property_type_name$property_type_name) == "One-to-four family dwelling (other than manufactured housing)"] <- "1 to 4family dwelling"

homeMortgage_applicant_type= homeMortgage %>% group_by(property_type_name,Loan_Approval.level) %>%
  summarise(CountOfActionTaken = n()) %>%
  arrange(desc(CountOfActionTaken))

levels(homeMortgage_applicant_type$property_type_name)[levels(homeMortgage_applicant_type$property_type_name) == "One-to-four family dwelling (other than manufactured housing)"] <- "1 to 4family dwelling"

homeMortgageStatus_type = inner_join(property_type_name,homeMortgage_applicant_type)%>%mutate(percentage = (CountOfActionTaken/count) * 100 )  

homeMortgageStatus_type %>% ggplot(aes(x = reorder(property_type_name, count), y = percentage)) + 
  geom_bar(stat = 'identity',colour="white", fill =fillColor) +
  facet_wrap(~Loan_Approval.level)+
  labs(x = 'Property Type Name', y = 'Percentage of Status', title = 'Loan Approval Status by Property Type') +
  coord_flip() + 
  theme_bw() 

#Histogram for preapproval_name
fillColor = "#1c9099"

preapproval_name <- homeMortgage %>%
  group_by(preapproval_name) %>% 
  summarize(count = n()) %>%
  arrange(desc(count)) 

homeMortgage_applicant_preapproval= homeMortgage %>% group_by(preapproval_name,Loan_Approval.level) %>%
  summarise(CountOfActionTaken = n()) %>%
  arrange(desc(CountOfActionTaken))

homeMortgageStatus_preapproval = inner_join(preapproval_name,homeMortgage_applicant_preapproval) 

homeMortgageStatus_preapproval %>% ggplot(aes(x= reorder(preapproval_name, count),y=CountOfActionTaken)) + 
 geom_bar(stat = 'identity',colour="white", fill =fillColor) +
  facet_wrap(~Loan_Approval.level)+
  labs(x = 'Preapproval name', y = 'Count of Status', title = 'Loan Approval Status by Proapproval Name ') +
  coord_flip() + 
  theme_bw() 

#purchaser type and loan action
fillColor = "#1c9099"

purchaser_type_name <- homeMortgage %>%
  group_by(purchaser_type_name) %>% 
  summarize(count = n()) %>%
  arrange(desc(count)) 

homeMortgage_purchaser_type= homeMortgage %>% group_by(purchaser_type_name,Loan_Approval.level) %>%
  summarise(CountOfActionTaken = n()) %>%
  arrange(desc(CountOfActionTaken))

homeMortgageStatus_purchaser = inner_join(purchaser_type_name,homeMortgage_purchaser_type)%>%mutate(percentage = (CountOfActionTaken/count) * 100 ) 

homeMortgageStatus_purchaser %>% ggplot(aes(x= reorder(purchaser_type_name, count),y= percentage)) + 
 geom_bar(stat = 'identity',colour="white", fill =fillColor) +
  facet_wrap(~Loan_Approval.level)+
  labs(x = 'Purchaser type', y = 'Percentage of Status', title = 'Loan Approval Status by Purchaser Type') +
  coord_flip() + 
  theme_bw() 

```
##6.	Define a variable “Loan_Approval” based on the action taken on loan. Discuss how you defined this variable.

We refer to Moody's economic analysis report and give out the loan approval definition of our own: loan originated, loan purchased by the institution and loan approved but not accpeted are all considerred loan approval. Loan purchaded by the institution is defined as loan pre-approved by bank then sell to other financial institution. The major difference is whether the institution offers deposit account. Loan approved but not accepted is also included in loan approval, because this type of applications meets the loan approval qualification. It's their own choices to accept or not. 

##7. Discuss what the data patterns indicate, and what this could mean for the probability of getting a loan approved.
```{r}
#loan mean comparison
ln = homeMortgage %>% filter(Loan_Approval == "1")
mean1=mean(ln$loan_amount_000s,na.rm=TRUE)
print(mean1)

ln1 = homeMortgage %>% filter(Loan_Approval == "0")
mean2= mean(ln1$loan_amount_000s,na.rm = TRUE)
print(mean2)

# t test
t.test(ln$loan_amount_000s,ln1$loan_amount_000s)
# T-test type: Independent-Samples (or Unpaired Samples) t-test
# Null hypothesis: true difference in means of loan amounts between approval or not is equal to 0
#p < 0.05, significantly reject the null hypothesis, which shows that the mean of loan amout between approved or not approved is significantly different from each other.



#High and low income threshold
homeMortgage = homeMortgage %>%
  mutate(Income_Level = ifelse(applicant_income_000s>=68.7, "1", "0"))
# The low income standard is the standard given by New York State government. And combined with consideration of median of the income, we use 68.7 as a threshold to divide the high and low income body. 
# t test
inc = homeMortgage %>% filter(Loan_Approval == "1",Income_Level=="1")
inc_1 = homeMortgage %>% filter(Income_Level=="1")
inc_1_0 = homeMortgage %>% filter(Loan_Approval == "0",Income_Level=="1")
count_1_1 = nrow(inc)
count_1 = nrow(inc_1)
count_1_0 = nrow(inc_1_0)
Rate_high = count_1_1/count_1
print(Rate_high)

inc1 = homeMortgage %>% filter(Loan_Approval == "1",Income_Level=="0")
inc_0 = homeMortgage %>% filter(Income_Level=="0")
inc_0_0 = homeMortgage %>% filter(Loan_Approval == "0",Income_Level=="0")
count1_0 = nrow(inc1)
count_0 = nrow(inc_0)
count_0_0 = nrow(inc_0_0)
Rate_low = count1_0/count_0
print(Rate_low)

# chi-square test
chisq.data = matrix(c(count_1,count_1_0,count1_0,count_0_0), nrow = 2, ncol = 2)
rownames(chisq.data) = c("High Income","Low Income")
colnames(chisq.data) = c("Loan Approval","Loan not Approved")

chisq.test(chisq.data)
#The chi-square test tests whether the row and column variables are independent (Null Hypothesis) or are associated (Alternate Hypothesis). Here, we are measuring, whether high and low income would influence the possibility of getting loan approved.
#NUll hypothesis, The income level and loan approval condition are independent (not significantly influence each other)
#p<0.05, null hypothesis is rejected, which shows that there is a signigicant difference of loan approval rate between high and low income.
```

From the bivariate analysis, we could find there are certain pattern in out data. 
a. We find that most undisclosured information (not applicable) leads to loans purchased by the institution.
   *Race and loan originated: White is the race which is the most likely get the loan originated also the race who apply the loan most.
   *Ethnicity:Not hispanic has higher possibility of getting loan originated than hispanic/latino.
   *County: county seems make difference on loan actions, but we are eager to believe such differenc is not caused by the geographic location itself, but the characteristics of applicants live in such counties matter more.
   *Income: we find out the income distribution has similar patterns in different loan actions.Most applicants of home mortgage have the income range from 25000 to 150000, and the most people has the income of 75000.
   *Loan amount: most applicants apply for loan amount range from 50000 to 500000, and most likely, when loan amount falls into 100 to 300 is most likely to get the application approved.
   *Hoepa status: whether holding a hoepa loan or not will influence the loan application result is hard to be measured from the current data. Most people who apply home mortgage dont hold a hoepa loan. About half of the non-hoepa-loan holders will get their home mortgage loan originated.
   *Lien status: Most people who apply for homeMortgage are secured by a first lien and they are more likely to get the loan originated.
   *Loan purpose: most people who apply for home mortage have the purpose of home purchase than refinancing, least people apply for home improvement. The possibility of getting loan originated is slightly higher in home purchase than refinancing and home improvement.
   *Loan type: loan type would impact the loan origination.Conventional loan are obviously more likely to get originated compared the rest. But, the insured applications, especially FHA-insured ansd FAS/RHS-guaranteed are more likely to get loan purchased by institution.
  *Property type: almost all applications are for one to four family dwelling property, and around half of the application would be originated, followed by the possibility of denied by financial institution or purchased by other institution, followed by smaller number of applications withdrawed by applicants.
  *Preapproval: a large number of applicants dont have the applicable information about preapproval requirement, whether preapproval is required does not significantly affect the loan origination, as it shows that most applicant will get loan originated with or without preapproval.
  *Purchaser type: does influence the loan origination, it has significant differences among different types of purchasers. Mostly, the loan purchaser is insurance firm or commercial bank, which we called traditional financial institute is mostly like to let the loan originated 


##8. Discuss the determinants of loan approval with respect to loan amounts, household income, applicant’s gender and race. Clearly state the dependent and independent variables used in your regression analysis. Interpret the findings of this analysis, and note the R-squared.
*need to change the code based on previous impute data!
```{r}
#define independent  and dependent variables
logit_variables = c("Loan_Approval",        
"applicant_income_000s","applicant_race_1","applicant_sex","loan_amount_000s")

#subet the data
homeMortgage_logit = homeMortgage[,logit_variables]

is.factor(homeMortgage_logit$Loan_Approval)

#check missing value
sapply(homeMortgage_logit,function(x) sum(is.na(x)))

#Impute the missing data by replace it with col mean
homeMortgage_logit$applicant_income_000s[is.na(homeMortgage_logit$applicant_income_000s)] <- mean(homeMortgage_logit$applicant_income_000s,na.rm=T)

#re-check missing value
sapply(homeMortgage_logit,function(x) sum(is.na(x)))

#convert to factors
homeMortgage_logit$applicant_race_1 <- as.factor(homeMortgage_logit$applicant_race_1)
homeMortgage_logit$applicant_sex <- as.factor(homeMortgage_logit$applicant_sex)

homeMortgage_logit$Loan_Approval <- as.factor(homeMortgage_logit$Loan_Approval)

#build the basic binomial logistic regression
model_1 <- glm(Loan_Approval~., family=binomial(link='logit'), data = homeMortgage_logit)

options(scipen = 999)
summary(model_1)

#produce the formula
as.formula(
  paste0("Loan_Approval~", round(coefficients(model_1)[1],3), "", 
    paste(sprintf(" %+.2f*%s ", 
                  coefficients(model_1)[-1],  
                  names(coefficients(model_1)[-1])), 
          collapse="")
  )
)

#compute Pseudo-R-squared
nagelkerke(model_1)

```
*The dependent variablei is Loan_Approval, and the independent variables are loan amounts, household income, appllicant's gender and race.
*The logit model is(Pseudo.R.squared=0.0818422) :
Loan_Approval ~ -0.494 - 0 * applicant_income_000s + 0.68 * applicant_race_12 + 
    0.15 * applicant_race_13 + 0.31 * applicant_race_14 + 0.85 * 
    applicant_race_15 + 0.23 * applicant_race_16 + 0.4 * applicant_race_17 + 
    0.03 * applicant_sex2 + 0.15 * applicant_sex3 - 2.17 * applicant_sex4 + 
    0 * loan_amount_000s
*Note:
applicant_race_11:American Indian or Alaska Native
applicant_race_12:Asia
applicant_race_13: Balck or African American
applicant_race_14:Native Hawaiian or Other Pacific Islander
applicant_race_15:White
applicant_race_16:Information not provided by applicant in mail, Internet, or telephone application	
applicant_race_17:Not applicable 
applicant_sex1:Male
applicant_sex2:Female
applicant_sex3:Information not provided by applicant in mail, Internet, or telephone application
applicant_sex4:No applicatable

*Model interpretation: 
All independent variables are statistically significant(p<0.05) in our model.Given all other variables being equal, Asia applicant will increase the log odds(of being originated) by 0.68 compared with American Indian or Alaska Native applicant;applicant with race Balck or African American will increase the log odds(of being originated) by 0.15 compared with American Indian or Alaska Native applican ; applicant with race Native Hawaiian or Other Pacific Islander will increase the log odds(of being originated) by 0.16 compared with American Indian or Alaska Native, White applicant will increase the log odds(of being originated) by 0.85 compared with American Indian or Alaska Native, applicant with race information abse nce will increase the log odds(of being originated) by 0.23 compared with American Indian or Alaska Native, applicant with with race information not applicatable will increase the log odds(of being originated) by 0.4 compared with American Indian or Alaska Native applicant; while control all other variables equal, female applicant with sex will increase the log odds(of being originated) by 0.03 compared to male applicant, applicant with sex information absence will increase the log odds(of being originated) by 0.15 compared to male applicant, applicant with sex information not applicatable will decrease the log odds(of being originated) by 2.17 compared to male applicant.

##9. You may extend this analysis by further controlling for omitted variable biases. Mention which variables you are using as controls, and re-do the regression from part (6) after adding these controls. Interpret your findings and note the change in R-squared. [Hint: For this part, you may split your data into “train” and “test” datasets, and comment on which regression model provides the best fit. Alternatively, you may use any of likelihood or Information Criterion techniques discussed in class.]

```{r, warning = FALSE}
#adding controls to original regression data set: county, Loan type, Purchaser type,Lien status
homeMortgage_logit2 <- cbind(homeMortgage_logit,homeMortgage[,c('loan_type', 'purchaser_type','lien_status')])
sapply(homeMortgage_logit2,function(x) sum(is.na(x)))

homeMortgage_logit2$loan_type <- as.factor(homeMortgage_logit2$loan_type)
homeMortgage_logit2$purchaser_type <- as.factor(homeMortgage_logit2$purchaser_type)
homeMortgage_logit2$lien_status <- as.factor(homeMortgage_logit2$lien_status)

#expand to more models based on homeMortgage_logit2 dataset 
test1Vec = c('','+applicant_income_000s')
test2Vec = c('','+applicant_sex')
test3Vec = c('','+applicant_race_1')
test4Vec = c('','+loan_amount_000s')
test5Vec = c('','+loan_type')
test6Vec = c('','+purchaser_type')
test7Vec = c('','+lien_status')
formulaSet = paste('Loan_Approval~1',
apply(expand.grid(test1Vec, test2Vec, test3Vec, test4Vec, test5Vec,test6Vec, test7Vec),1,paste,collapse=''))

logit2_model = NULL
logit_aic = NULL
for(i in 1:length(formulaSet)){
  logit2_model[[i]] = glm(formulaSet[i], family=binomial(link='logit'), data = homeMortgage_logit2)
  logit_aic[i] <- summary(logit2_model[[i]])$aic
}

min.aic = which.min(logit_aic)
paste("Best Model= ",formulaSet[min.aic])
paste("AIC of Best Model =",logit_aic[min.aic])

#get summary of the best model
summary(logit2_model[[min.aic]])

#get Pseudo_RSquare
nagelkerke(logit2_model[[min.aic]])

```
*Control variables are selected based on previous bivariate anlysis.The control variables : loan amounts, household income, applicant’s gender and race,loan type, purchaser type,lien status to the control model. 


##10. In your final selected model, are there any significant customer segments based on demographics? Explain.
```{r}
#print the best model
summary(logit2_model[[min.aic]])
```
*From our final selected model, we have applicant income, applicant race, applicant sex are all demographic factors. Accroding to statistical significace of those variables, we found different segments will have different proabilityof loan originated. For example, applicant with race White or Asia are both statistically significant(p<0.001) in our model, and they all have higher log odds(of being originated) than the American Indian or Alaska Native segments when control other variables equal. Also, the three sex categorical variables are all statistically significant (p<0.001) in our model with different log odds(of being originated) compared with that of male when control other variables equal, which means sex could be also considered as segmentation factors.

     
##11.Using your final selected model, predict the mean approval rating for the major segments. 
applicant_sex3           Information not provided by applicant in mail, Internet, or telephone application ***
applicant_sex4           No applicatable ***
applicant_race_12        Asia ***
applicant_race_15        White ***
applicant_race_16        Information not provided by applicant in mail, Internet, or telephone application ** 
applicant_race_17        Not applicable ***
*For the loan approval mean rating analysis, there are total 8 major segments based on the best logit model. The eight segmentations are

```{r, warning = FALSE}
#load the model
model_best <- logit2_model[[min.aic]]

#median of applicant income
median_applicant_income_000s <- 102
  
#median of loan amout
median_loan_amount_000s <- 208

#mode of loan type 1:Conventional
mode_loan_type <- 1

#mode of purchaser type 0:Loan was not originated or was not sold
mode_purchaser_type <- 0

#mode of lien status 1:Secured by a first lien
mode_lien_status <- 1
  
#segment one: sex = 3, race = 2
segment_one <- data.frame(applicant_income_000s = median_applicant_income_000s, applicant_race_1 = as.factor(2), applicant_sex = as.factor(3),loan_amount_000s = median_loan_amount_000s, loan_type = as.factor(mode_loan_type), purchaser_type = as.factor(mode_purchaser_type), lien_status = as.factor(mode_lien_status))

seg_one <- predict(model_best,segment_one,type='response')
paste("Segmentation One is Asia with sex 'Information not provided by applicant in mail, Internet, or telephone application', and the mean approval rate = ",seg_one)

#segment two:sex = 3, race = 5
segment_two <- data.frame(applicant_income_000s = median_applicant_income_000s, applicant_race_1 = as.factor(5), applicant_sex = as.factor(3),loan_amount_000s = median_loan_amount_000s, loan_type = as.factor(mode_loan_type), purchaser_type = as.factor(mode_purchaser_type), lien_status = as.factor(mode_lien_status))

seg_two <- predict(model_best,segment_two,type='response')
paste("Segmentation Two is White with sex 'Information not provided by applicant in mail, Internet, or telephone application', and the mean approval rate = ",seg_two)

#segment three :sex = 3, race = 6
segment_three <- data.frame(applicant_income_000s = median_applicant_income_000s, applicant_race_1 = as.factor(6), applicant_sex = as.factor(3),loan_amount_000s = median_loan_amount_000s, loan_type = as.factor(mode_loan_type), purchaser_type = as.factor(mode_purchaser_type), lien_status = as.factor(mode_lien_status))

seg_three <- predict(model_best,segment_three,type='response')
paste("Segmentation Three is race 'Information not provided by applicant in mail, Internet, or telephone application' and sex 'Information not provided by applicant in mail, Internet, or telephone application', and the mean approval rate = ", seg_three)

#segment four :sex = 3, race = 7
segment_four <- data.frame(segment_three <- data.frame(applicant_income_000s = median_applicant_income_000s, applicant_race_1 = as.factor(7), applicant_sex = as.factor(3),loan_amount_000s = median_loan_amount_000s, loan_type = as.factor(mode_loan_type), purchaser_type = as.factor(mode_purchaser_type), lien_status = as.factor(mode_lien_status)))

seg_four <- predict(model_best,segment_four,type='response')
paste("Segmentation Four is race 'Not applicable' and sex 'Information not provided by applicant in mail, Internet, or telephone application', and the mean approval rate = ", seg_four)

#segment five: sex = 4, race = 2
segment_five <- data.frame(applicant_income_000s = median_applicant_income_000s, applicant_race_1 = as.factor(2), applicant_sex = as.factor(4),loan_amount_000s = median_loan_amount_000s, loan_type = as.factor(mode_loan_type), purchaser_type = as.factor(mode_purchaser_type), lien_status = as.factor(mode_lien_status))

seg_five <- predict(model_best,segment_one,type='response')
paste("Segmentation Five is Asia and sex 'Not applicable' and sex 'Information not provided by applicant in mail, Internet, or telephone application', and the mean approval rate = ", seg_five)


#segment six :sex = 4, race = 5
segment_six <- data.frame(applicant_income_000s = median_applicant_income_000s, applicant_race_1 = as.factor(5), applicant_sex = as.factor(4),loan_amount_000s = median_loan_amount_000s, loan_type = as.factor(mode_loan_type), purchaser_type = as.factor(mode_purchaser_type), lien_status = as.factor(mode_lien_status))

seg_six <- predict(model_best,segment_two,type='response')
paste("Segmentation Six is White and sex 'Not applicable', and the mean approval rate = ", seg_six)


#segment seven :sex = 4, race = 6
segment_seven <- data.frame(applicant_income_000s = median_applicant_income_000s, applicant_race_1 = as.factor(6), applicant_sex = as.factor(4),loan_amount_000s = median_loan_amount_000s, loan_type = as.factor(mode_loan_type), purchaser_type = as.factor(mode_purchaser_type), lien_status = as.factor(mode_lien_status))

seg_seven <- predict(model_best,segment_three,type='response')
paste("Segmentation Seven is race 'Information not provided by applicant in mail, Internet, or telephone application' and sex 'Not applicable', and the mean approval rate = ", seg_seven)


#segment eight :sex = 4, race = 7
segment_eight <- data.frame(segment_three <- data.frame(applicant_income_000s = median_applicant_income_000s, applicant_race_1 = as.factor(7), applicant_sex = as.factor(4),loan_amount_000s = median_loan_amount_000s, loan_type = as.factor(mode_loan_type), purchaser_type = as.factor(mode_purchaser_type), lien_status = as.factor(mode_lien_status)))

seg_eight <- predict(model_best,segment_four,type='response')
paste("Segmentation Eight is race 'Not applicable' and sex 'Not applicable', and the mean approval rate = ", seg_eight)

```

##12. Summarize your findings for the loan approval, and make recommendations for the proabability of getting a loan approved. Suggest managerial uses for using this loan approval database in business applications.

We have several findings directly from statistic analysis:
*Income: The approved loan applicants do have significantly different average income compared to those who failed to pass the loan approval check. Higher income group would be more likely to get loan approved.
*When control all other variables being equal, White applicant and Asia applicant have higher probability to get loan approved than American Indian or Alaska Native;
*Coventional loan is more likely to get approved compared to all other types of loan, which holding all other variables equal;
*Purchaser type belongs to Fannie Mae (FNMA) has higher probability of getting the loan aproved compared with other purchaser types, when holding all other variables equal;
*Lien status is 'Secured by a first lien' is more likely to get approved compared to all other lien status, which holding all other variables equal;
*Loan amount: The approved loan applications have significantly different average loan amount compared to those not approved. From the t-test, the approved average loan amount is higher than non approved loan amount, which makes sense, as lower income applicants are less likely to have strong credit profile and have less incentive to purchase high price property, which leads to lower loan amount requested in application.



##13. Referrence
*https://protobi.com/post/estimate-and-profile-segmentations
*http://statistics.ohlsen-web.de/latent-class-analysis-polca/
*https://rpubs.com/cheevahagadog/hw
*https://www.economy.com/support/blog/buffet.aspx?did=00BA3159-4C45-43EF-A56B-0276A6C79212
*https://www.r-bloggers.com/learn-logistic-regression-and-beyond/

##Appendix
